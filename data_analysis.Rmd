---
title: "Data Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r}
library(tidyverse)
library(patchwork)
library(haven)
library(gganimate)
library(gifski)
library(ggplot2)
data <- read_sas("data/chs2017_public.sas7bdat")

knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 6,
  out.width = "90%"
  )

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colur_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{r}
data_clean = 
  data %>% 
  select(imputed_foodinsecure, toldhighbp17, diabetes17, weight17in4, currdepress, agegroup, sex, newrace) %>% 
  mutate(
    imputed_foodinsecure = recode(imputed_foodinsecure, 
              "1" = "0", 
              "2" = "0",
              "3" = "1",
              "4" = "1"),
    imputed_foodinsecure = as.numeric(imputed_foodinsecure),
    toldhighbp17 = recode(toldhighbp17,
                          "1" = "1",
                          "2" = "0"),
    toldhighbp17 = as.numeric(toldhighbp17),
    diabetes17 = recode(diabetes17,
                        "1" = "1",
                        "2" = "0"),
    diabetes17 = as.numeric(diabetes17),
    weight17in4 = recode(weight17in4,
                         "1" = "0",
                         "2" = "0",
                         "3" = "0",
                         "4" = "1"),
  weight17in4 = as.numeric(weight17in4),
    currdepress = recode(currdepress,
                         "1" = "1",
                         "2" = "0"),
  currdepress = as.numeric(currdepress),
    agegroup = recode(agegroup,
                      "1" = "18-24",
                      "2" = "25-44",
                      "3" = "45-64",
                      "4" = "65+"),
    sex = recode(sex, 
                 "1" = "Male",
                 "2" = "Female"),
    newrace = recode(newrace,
                     "1" = "White non-Hispanic",
                     "2" = "Black non-Hispanic",
                     "3" = "Hispanic",
                     "4" = "Asian/PI/non-Hispanic",
                     "5" = "Other non-Hispanic"),
  ) %>%  
  rename("Food_Insecure" = imputed_foodinsecure,
         "High_BP" = toldhighbp17,
         "Diabetes" = diabetes17,
         "Obesity" = weight17in4,
         "Depression" = currdepress,
         "Age" = agegroup,
         "Sex" = sex,
         "Race" = newrace) %>% 
  drop_na()
```

## Exploratory Analyses

We assessed the distribution of food insecurity and select chronic health outcomes by age, race, and sex. 

```{r}
##Creating five individual bar charts to represent the distribution of the outcomes against age and race.

plot1 = 
data_clean %>% 
  select(Age, Food_Insecure, Race, Sex) %>% 
  count(Age, Food_Insecure, Race, Sex) %>% 
  group_by(Age, Race, Sex) %>% 
  mutate(
    total = sum(n)) %>% 
  filter(Food_Insecure == "1") %>% 
  mutate(
    Total_Insecure = sum(n),
    Proportion = Total_Insecure / total)


plot1 %>% 
ggplot() +
  geom_col(aes(x = Age, y = Total_Insecure, fill = Race)) +
  facet_wrap(Sex ~.) +
  labs(
    x = "Age Group",
    y = "Food Insecure Count",
    title = "Food Insecurity by Age, Race, and Sex",
    caption = "Data from Community Health Survey (2017)"
  )

plot2 = 
data_clean %>% 
  select(Age, Obesity, Race, Sex) %>% 
  count(Age, Obesity, Race, Sex) %>% 
  group_by(Age, Race, Sex) %>% 
  mutate(
    total = sum(n)) %>% 
  filter(Obesity == "1") %>% 
  mutate(
    Total_Obese = sum(n),
    Proportion = Total_Obese / total)


plot2 %>% 
ggplot() +
  geom_col(aes(x = Age, y = Total_Obese, fill = Race)) +
  facet_wrap(Sex ~.) +
  labs(
    x = "Age Group",
    y = "Obesity Count",
    title = "Obesity by Age, Race, and Sex",
    caption = "Data from Community Health Survey (2017)"
  )

plot3 = 
data_clean %>% 
  select(Age, Diabetes, Race, Sex) %>% 
  count(Age, Diabetes, Race, Sex) %>% 
  group_by(Age, Race, Sex) %>% 
  mutate(
    total = sum(n)) %>% 
  filter(Diabetes == "1") %>% 
  mutate(
    Total_Diabetes = sum(n),
    Proportion = Total_Diabetes / total)


plot3 %>% 
ggplot() +
  geom_col(aes(x = Age, y = Total_Diabetes, fill = Race)) +
  facet_wrap(Sex ~.) +
  labs(
    x = "Age Group",
    y = "Diabetes Count",
    title = "Diabetes by Age, Race, and Sex",
    caption = "Data from Community Health Survey (2017)"
  )

plot4 = 
data_clean %>% 
  select(Age, High_BP, Race, Sex) %>% 
  count(Age, High_BP, Race, Sex) %>% 
  group_by(Age, Race, Sex) %>% 
  mutate(
    total = sum(n)) %>% 
  filter(High_BP == "1") %>% 
  mutate(
    Total_High_BP = sum(n),
    Proportion = Total_High_BP / total)


plot4 %>% 
ggplot() +
  geom_col(aes(x = Age, y = Total_High_BP, fill = Race)) +
  facet_wrap(Sex ~.) +
  labs(
    x = "Age Group",
    y = "High Blood Pressure Count",
    title = "High Blood Pressure by Age, Race, and Sex",
    caption = "Data from Community Health Survey (2017)"
  )

plot5 = 
data_clean %>% 
  select(Age, Depression, Race, Sex) %>% 
  count(Age, Depression, Race, Sex) %>% 
  group_by(Age, Race, Sex) %>% 
  mutate(
    total = sum(n)) %>% 
  filter(Depression == "1") %>% 
  mutate(
    Total_Depress = sum(n),
    Proportion = Total_Depress / total)

plot5 %>% 
ggplot() +
  geom_col(aes(x = Age, y = Total_Depress, fill = Race)) +
  facet_wrap(Sex ~.) +
  labs(
    x = "Age Group",
    y = "Depression Count",
    title = "Depression by Age, Race, and Sex", 
    caption = "Data from Community Health Survey (2017)"
  )

```

## Logistic Regression

The association between food insecurity and the following chronic health outcomes were assessed via logistic regression, adjusting for race, sex, age. 

**Obesity**

```{r}
fit_logistic_obesity = 
  data_clean %>% 
  glm(Obesity ~ Food_Insecure + Age + Sex + Race, data = ., family = binomial())

fit_logistic_obesity %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         High_CI = exp(estimate + 1.96*std.error),
         Low_CI = exp(estimate - 1.96*std.error)) %>% 
  select(term, log_OR = estimate, OR, p.value, High_CI, Low_CI) %>% 
  knitr::kable(digits = 3)
```

**High Blood Pressure**

```{r}
fit_logistic_High_BP = 
  data_clean %>% 
  glm(High_BP ~ Food_Insecure + Age + Sex + Race, data = ., family = binomial())

fit_logistic_High_BP %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         High_CI = exp(estimate + 1.96*std.error),
         Low_CI = exp(estimate - 1.96*std.error)) %>% 
  select(term, log_OR = estimate, OR, p.value, High_CI, Low_CI) %>% 
  knitr::kable(digits = 3)
```

**Depression**

```{r}
fit_logistic_Depression = 
  data_clean %>% 
  glm(Depression ~ Food_Insecure + Age + Sex + Race, data = ., family = binomial())

fit_logistic_Depression %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         High_CI = exp(estimate + 1.96*std.error),
         Low_CI = exp(estimate - 1.96*std.error)) %>% 
  select(term, log_OR = estimate, OR, p.value, High_CI, Low_CI) %>% 
  knitr::kable(digits = 3)
```

**Diabetes**

```{r}
fit_logistic_Diabetes = 
  data_clean %>% 
  glm(Diabetes ~ Food_Insecure + Age + Sex + Race, data = ., family = binomial())

fit_logistic_Diabetes %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         High_CI = exp(estimate + 1.96*std.error),
         Low_CI = exp(estimate - 1.96*std.error)) %>% 
  select(term, log_OR = estimate, OR, p.value, High_CI, Low_CI) %>% 
  knitr::kable(digits = 3)
```

## Summary of Logistic Regression Findings

```{r}
oddsratios_full = tibble(
  outcome = c("Obesity", "High BP", "Depression", "Diabetes"),
  OR = c(1.111, 1.555, 4.422, 1.491),
  pvalue = c(0.208, 0.000, 0.000, 0.000),
  Low_CI = c(0.943, 1.312, 3.695, 1.220),
  High_CI = c(1.309, 1.842, 5.291, 1.823))

oddsratios_full %>% 
  ggplot(aes(x = OR, y = outcome, group = 1)) +
  geom_vline(aes(xintercept = 1), linetype = "dashed") +
  geom_errorbarh(aes(xmax = High_CI, xmin = Low_CI), size = 0.5, height = 0.2) +
  geom_point(size = 3.5, color = "orange") +
  ylab("") +
  xlab("Odds Ratio") +
  ggtitle("Food insecurity and odds of select outcomes") +
  labs(
    caption = "Data from Community Health Survey (2017)"
  )
```
